---
- hosts: all
  remote_user: myockey
  tasks:
    - name: Clone project repo
      git:
        repo: ssh://git@github.com/yock/mikeyockey-rails.git
        dest: ~/src

    - name: Pull Docker image for database
      docker_image:
        name: postgres:9

    - name: Pull Docker image for site
      docker_image:
        name: yock/mikeyockey-rails:latest
        force: yes

    - name: Start Database
      docker_container:
        name: postgres
        image: postgres:9
        published_ports:
          - 5432:5432
        volumes:
          - /var/lib/postgresql/data

    - name: Run database migrations
      docker_container:
        name: migrations
        image: yock/mikeyockey-rails
        command: db:migrate
        detach: no
        links:
          - "postgres:postgres"
        env:
          RAILS_ENV: production
          SECRET_KEY_BASE: 7cb7bf4edcf9c118975ad21690989c69cb3cb102ffb3bea2eaa147f04392e5423eea768905d2be9674a9584412cac3286bb78c6216ce993d67601af493fd4764

    - name: Start app
      docker_container:
        name: rails
        image: yock/mikeyockey-rails
        command: server
        detach: no
        links:
          - "postgres:postgres"
        published_ports:
          - 80:3000
        env:
          RAILS_ENV: production
          SECRET_KEY_BASE: 7cb7bf4edcf9c118975ad21690989c69cb3cb102ffb3bea2eaa147f04392e5423eea768905d2be9674a9584412cac3286bb78c6216ce993d67601af493fd4764
